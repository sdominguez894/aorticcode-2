erDiagram

%% ============================
%% CORE TABLES
%% ============================
BODIES {
    BIGSERIAL id PK
    TEXT code
    NUMERIC diameter
    NUMERIC length
    NUMERIC short_leg
    NUMERIC long_leg
    BIGINT device_id FK
    TIMESTAMPTZ created_at
    TIMESTAMPTZ updated_at
}

BRANCHES {
    BIGSERIAL id PK
    TEXT code
    NUMERIC diameter
    NUMERIC length
    BIGINT device_id FK
    TIMESTAMPTZ created_at
    TIMESTAMPTZ updated_at
}

AUDIT_LOG {
    BIGSERIAL id PK
    TEXT table_name
    BIGINT record_id
    TEXT action
    JSONB old_data
    JSONB new_data
    UUID changed_by
    TEXT db_user
    TEXT user_email
    TEXT user_role
    BIGINT case_id FK
    TIMESTAMPTZ changed_at
}

%% ============================
%% EXTENDED TABLES
%% ============================
MANUFACTURERS {
    BIGSERIAL id PK
    TEXT name
    TEXT country
    TEXT website
    TIMESTAMPTZ created_at
}

DEVICES {
    BIGSERIAL id PK
    BIGINT manufacturer_id FK
    TEXT name
    TEXT device_type
    TEXT model_code
    BOOLEAN ce_mark
    TEXT notes
    TIMESTAMPTZ created_at
}

PATIENTS {
    UUID id PK
    INT age
    TEXT sex
    NUMERIC height
    NUMERIC weight
    TEXT notes
    TIMESTAMPTZ created_at
}

ANATOMICAL_MEASUREMENTS {
    BIGSERIAL id PK
    UUID patient_id FK
    TEXT measurement_name
    NUMERIC value
    TEXT unit
    TIMESTAMPTZ created_at
}

RECOMMENDATIONS {
    BIGSERIAL id PK
    UUID patient_id FK
    BIGINT body_id FK
    BIGINT[] branch_ids
    UUID generated_by
    TEXT version
    TEXT notes
    TIMESTAMPTZ created_at
}

USERS {
    UUID id PK
    TEXT name
    TEXT email
    TEXT role
    TIMESTAMPTZ created_at
}

DEVICE_SPECS {
    BIGSERIAL id PK
    BIGINT device_id FK
    TEXT parameter_name
    TEXT parameter_value
    TIMESTAMPTZ created_at
}

%% ============================
%% RELATIONSHIPS
%% ============================
MANUFACTURERS ||--o{ DEVICES : "produces"
DEVICES ||--o{ BODIES : "defines model for"
DEVICES ||--o{ BRANCHES : "defines model for"
DEVICES ||--o{ DEVICE_SPECS : "has specifications"
PATIENTS ||--o{ ANATOMICAL_MEASUREMENTS : "has measurements"
PATIENTS ||--o{ RECOMMENDATIONS : "receives"
BODIES ||--o{ RECOMMENDATIONS : "used in"
USERS ||--o{ RECOMMENDATIONS : "generated by"
RECOMMENDATIONS ||--o{ AUDIT_LOG : "referenced in"
